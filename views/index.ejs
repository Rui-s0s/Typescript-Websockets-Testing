<!DOCTYPE html>
<html>
<head>
    <title>NestJS Chat</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* Simple layout for the user section */
        #chat-container { display: flex; gap: 20px; }
        #messages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; flex: 3; padding: 10px; }
        #users-section { flex: 1; border: 1px solid #eee; padding: 10px; background: #f9f9f9; }
        .system-msg { color: #888; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1 id="room-title">NestJS Chat</h1>
    
    <div id="login">
        <input id="username" placeholder="Username">
        <input id="room" placeholder="Room">
        <button onclick="connect()">Join</button>
    </div>

    <div id="chat" style="display:none">
        <div id="chat-container">
            <div id="messages"></div>
            <div id="users-section">
                <h3>Users Online</h3>
                <div id="user-count">Count: 0</div>
            </div>
        </div>
        <input id="msg" placeholder="Type message...">
        <button onclick="send()">Send</button>
    </div>

    <script>
        const socket = io();

        function connect() {
            const username = document.getElementById('username').value;
            const room = document.getElementById('room').value;
            if(!username || !room) return alert("Enter details");

            socket.emit('joinRoom', { username, room });

            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
            document.getElementById('room-title').textContent = `Room: ${room}`;
        }

        function send() {
            const message = document.getElementById('msg').value;
            const room = document.getElementById('room').value;
            const username = document.getElementById('username').value;

            socket.emit('sendMessage', { room, username, message });
            document.getElementById('msg').value = '';
        }

        // --- Event Listeners ---

        // Listen for the user count update
        socket.on('userCount', (data) => {
            console.log('User count received:', data); // Debugging
            const countElement = document.getElementById('user-count');
            if (countElement) {
                countElement.textContent = `Count: ${data.count}`;
            }
        });

        // Listen for our special "Notification" event
        socket.on('userStatusUpdate', (data) => {
            const div = document.getElementById('messages');
            const p = document.createElement('p');
            p.className = 'system-msg';
            p.textContent = data.message; // e.g. "John has disconnected"
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        });

        socket.on('newMessage', (msg) => {
            const div = document.getElementById('messages');
            const p = document.createElement('p');

            // Attach deterministic ID POSSIBLE IMPLEMENTATION FOR TESTING PURPOSES
            if (msg.id) {
                p.dataset.id = msg.id;
            }

            const date = msg.timestamp ? new Date(msg.timestamp) : new Date();
            const timeStr = `[${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}] `;

            const timeSpan = document.createElement('span');
            timeSpan.style.color = '#666';
            timeSpan.textContent = timeStr;

            const strong = document.createElement('strong');
            strong.textContent = `${msg.username}: `;

            const text = document.createTextNode(msg.message);

            p.appendChild(timeSpan);
            p.appendChild(strong);
            p.appendChild(text);

            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        });

    </script>
</body>
</html>